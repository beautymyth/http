<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Promised Based Http Client for Real Project</title>
  <script src="//lib.baomitu.com/jquery/1.12.4/jquery.min.js"></script>
  <script src="//lib.baomitu.com/axios/0.18.0/axios.min.js"></script>
  <script src="../dist/http.js"></script>
</head>
<body>
<script>
// 可加上各平台模拟测试

function Deferred() {
  this.promise = new Promise((resolve, reject) => {
    this.resolve = resolve
    this.reject = reject
  })
  this.throwIfRequested = function() {}
}

var deferred = new Deferred()

$(() => {
  var formData = new FormData()
  formData.append('key', 'value')

  fetch('/json', {
    method: 'POST',
    body: formData
  }).then(response => {
    return response.json()
  }).then(x => {
    console.log(x, 99999999)
  }).catch(err => {
    console.log(err, 99999999)
  })

  $.ajax('/json', {data: {}, timeout: 1}).then((...args) => {
    console.log('jquery success', ...args)
  }, (...args) => {
    console.log('jquery error', ...args, args)
  })

  const CancelToken = axios.CancelToken
  const source = CancelToken.source()
  // axios.defaults.timeout = 0.001 * 1000
  axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded'
  // axios.defaults.cancelToken = source.token
  axios.interceptors.request.use(config => {
    console.log('config', config)
    if (config.cancelToken !== null) {
      config.cancelToken = source.token
    }
    return config
  })

  axios.interceptors.response.use(response => {
    console.log('response', response)
    return response
  })

  axios.post('/timeout', 0, {
    params: {
      from: 'axios'
    },
    headers: {'content-type': 'application/x-www-form-urlencoded', 'a-b': 'b'},
    responseType: 'text'
  }).then((...args) => {
    console.log('axios success', ...args)
  }).catch(err => {
    console.log('axios error', err)
    console.dir(err)
  })

  axios.post('/timeout', 0, {
    params: {
      from: 'axios'
    },
    headers: {'content-type': 'application/x-www-form-urlencoded', 'a-b': 'b'},
    responseType: 'text',
    cancelToken: null
  }).then((...args) => {
    console.log('axios success', ...args)
  }).catch(err => {
    console.log('axios error', err)
    console.dir(err)
  })

  setTimeout(() => {
    source.cancel(55555)
    source.cancel(66666)
    deferred.resolve(44444)
  }, 500)


  fetch('/badjson', {
    body: JSON.stringify({
      fetch: true
    }),
    headers: {
      'content-type': 'application/json'
    },
    method: 'POST'
  }).then((...args) => {
    console.log('fetch success', ...args)
    var response = args[0]
    var headers = [...response.headers]
    console.log('headers', headers)
    return response.text()
  }).then(data => {
    console.log(7777, data)
  }).catch((...args) => {
    console.log('fetch error', ...args)
  })

  var httpDeferred = new http.CancelToken()
  var httpSource = http.CancelToken.source()

  http.defaults.timeout = 1000

  http.interceptors.response.use(response => {
    console.log('http response', response)
    return response
  })
  http.post('/timeout', formData, {
    params: {
      query: 'string',
      from: 'chunpuhttp'
    },
    cancelToken: httpSource.token
  }).then(response => {
    console.log('raw response', response)
  }).catch((...args) => {
    console.log('http error', ...args)
  })
  http.post('/timeout', formData, {
    params: {
      query: 'string',
      from: 'chunpuhttp'
    },
    cancelToken: httpDeferred
  }).then(response => {
    console.log('raw response', response)
  }).catch((...args) => {
    console.log('http error', ...args)
  })

  setTimeout(() => {
    httpSource.cancel('http source cancel')
    httpDeferred.resolve('http deferred cancel')
  }, 500)

  // axios.post('/body', {
  //   key: 'value',
  //   axios: true,
  // }, {
  //   responseType: 'text'
  // }).then((...args) => {
  //   console.log(2222, args)
  // })

  // test
  // var xhr = new XMLHttpRequest()
  // xhr.open('POST', '/json', false)
  // xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
  // xhr.send(formData)
})
</script>
</body>
</html>
